<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video Stream Watcher</title>
</head>
<body>

<video id="video-stream-target" controls autoplay></video>
<button id="watch-button">Watch</button>

<script src="https://cdn.jsdelivr.net/npm/base64-js@1.5.1/base64js.min.js"></script>
<script src="signalr.js"></script>
<script>
    let peerConnection;
    const config = {
        iceServers: [
            {url:'stun:stun4.l.google.com:19302'}
            // { 
            //   "urls": "turn:TURN_IP?transport=tcp",
            //   "username": "TURN_USERNAME",
            //   "credential": "TURN_CREDENTIALS"
            // }
        ],
        offerToReceiveVideo: true
    };

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("https://localhost:7143/hubs/broadcaster")
        .build();

    const video = document.querySelector("#video-stream-target");
    const watchButton = document.querySelector("#watch-button");
    
    watchButton.addEventListener('click', () => {
        connection.start()
            .then(() => {
                console.log('Connection started');
                return connection.invoke("RegisterWatcher"); // Уведомляем сервер, что зритель подключился
            })
            .catch(err => console.error('Error while starting connection: ', err));
    });
    
    //Получение предложения от стримера
    connection.on("offer", (id, description) => {
        //Когда зритель получает предложение SDP от стримера:
        console.log("Received offer: ", id, description);
        //Он создает новый RTCPeerConnection.
        peerConnection = new RTCPeerConnection(config);
        peerConnection
            //Задает удаленное описание с предложением вещателя
            .setRemoteDescription(description)
            //Создает ответ SDP и устанавливает его как локальное описание
            .then(() => peerConnection.createAnswer())
            .then(sdp => peerConnection.setLocalDescription(sdp))
            //Отправляет ответ SDP обратно вещателю с помощью «SendAnswer
            .then(() => {
                const localDescription = JSON.stringify(peerConnection.localDescription);
                console.log("Sending Answer: ", id, peerConnection.localDescription)
                return connection.invoke("SendAnswer", id, localDescription);
            });
        //Назначаем полученный медиапоток элементу video
        peerConnection.ontrack = event => {
            if (event.streams && event.streams[0]) {
                video.srcObject = event.streams[0];
                video.play().catch(e => console.error("Video play error:", e));
            } else {
                console.error("Received track but no stream available.");
            }
        };
        //Отправляем всех собранных ICE кандидатов  вещателю с помощью «SendCandidate»
        peerConnection.onicecandidate = function(e) {
            if (e.candidate) {
                const candidate = JSON.stringify(e.candidate);
                return connection.invoke("SendCandidate", id, candidate);
            }
        };
    });
    
    //ICE кандидаты  принимаются от вещателя и добавляются в RTCPeerConnection.
    connection.on("candidate", (id, candidate) => {
        console.log("Received candidate: ", id, candidate);
        peerConnection
            .addIceCandidate(new RTCIceCandidate(candidate))
            .catch(e => console.error(e));
    });

    connection.on("connect", () => {
        connection.invoke("RegisterWatcher");
    });

    connection.on("broadcaster", () => {
        connection.invoke("RegisterWatcher");
    });

    window.onunload = window.onbeforeunload = () => {
        connection.close();
        peerConnection.close();
    };
</script>
</body>
</html>