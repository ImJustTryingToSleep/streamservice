<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video Stream Watcher</title>
</head>
<body>

<video id="video-stream-target" controls autoplay></video>
<button id="watch-button">Watch</button>

<script src="https://cdn.jsdelivr.net/npm/base64-js@1.5.1/base64js.min.js"></script>
<script src="signalr.js"></script>
<script>
    let peerConnection;
    const config = {
        iceServers: [
            {url:'stun:stun4.l.google.com:19302'}
            // { 
            //   "urls": "turn:TURN_IP?transport=tcp",
            //   "username": "TURN_USERNAME",
            //   "credential": "TURN_CREDENTIALS"
            // }
        ],
        offerToReceiveVideo: true
    };

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("https://localhost:7143/hubs/broadcaster") // URL вашего хаба
        .build();

    const video = document.querySelector("#video-stream-target");
   //const video = document.querySelector("video");
    const watchButton = document.querySelector("#watch-button");

    video.addEventListener('loadedmetadata', () => {
        console.log("Video metadata loaded. Duration:", video.duration);
    });

    video.addEventListener('playing', () => {
        console.log("Video is playing");
    });

    video.addEventListener('pause', () => {
        console.log("Video is paused");
    });

    video.addEventListener('error', (e) => {
        console.error("Video error occurred:", e);
    });
    
    watchButton.addEventListener('click', () => {
        connection.start()
            .then(() => {
                console.log('Connection started');
                return connection.invoke("RegisterWatcher"); // Уведомляем сервер, что зритель подключился
            })
            .catch(err => console.error('Error while starting connection: ', err));
    });

    video.addEventListener('loadedmetadata', () => {
        console.log("Video metadata loaded.");
    });
    
    connection.on("offer", (id, description) => {
        console.log("Received offer: ", id, description); // Лог предложения
        peerConnection = new RTCPeerConnection(config);
        peerConnection
            .setRemoteDescription(description)
            .then(() => peerConnection.createAnswer())
            .then(sdp => peerConnection.setLocalDescription(sdp))
            .then(() => {
                const localDescription = JSON.stringify(peerConnection.localDescription);
                console.log("Sending Answer: ", id, peerConnection.localDescription)
                return connection.invoke("SendAnswer", id, localDescription);
            });
        
        peerConnection.ontrack = event => {
            if (event.streams && event.streams[0]) {
                video.srcObject = event.streams[0];
                video.play().catch(e => console.error("Video play error:", e));
            } else {
                console.error("Received track but no stream available.");
            }
        };
            
        peerConnection.onicecandidate = function(e) {
            if (e.candidate) {
                const candidate = JSON.stringify(e.candidate);
                return connection.invoke("SendCandidate", id, candidate);
            }
        };
    });

    connection.on("broadcaster", () => {
        console.log("A broadcaster has connected.");
        return connection.invoke("RegisterWatcher"); // Уведомляем следующее подключение
    });

    connection.on("candidate", (id, candidate) => {
        console.log("Received candidate: ", id, candidate);
        peerConnection
            .addIceCandidate(new RTCIceCandidate(candidate))
            .catch(e => console.error(e));
    });

    connection.on("connect", () => {
        connection.invoke("RegisterWatcher");
    });

    connection.on("broadcaster", () => {
        connection.invoke("RegisterWatcher");
    });

    window.onunload = window.onbeforeunload = () => {
        connection.close();
        peerConnection.close();
    };
</script>
</body>
</html>